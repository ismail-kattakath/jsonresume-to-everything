name: CI

on:
  pull_request:
    branches: [main]

jobs:
  install:
    name: Install dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Project
        uses: ./.github/actions/setup-project

  typecheck:
    name: Type check
    needs: install
    runs-on: ubuntu-latest
    env:
      RESUME_JSON_GIST: ${{ vars.RESUME_JSON_GIST || 'https://gist.githubusercontent.com/ismail-kattakath/89b610867a975476693d3f28219acd8b/raw/resume.json' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Project
        uses: ./.github/actions/setup-project

      - name: Download resume data
        run: npm run download-resume-json

      - name: Type check
        run: npx tsc --noEmit

  test:
    name: Tests & coverage
    needs: install
    runs-on: ubuntu-latest
    env:
      RESUME_JSON_GIST: ${{ vars.RESUME_JSON_GIST || 'https://gist.githubusercontent.com/ismail-kattakath/89b610867a975476693d3f28219acd8b/raw/resume.json' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Project
        uses: ./.github/actions/setup-project

      - name: Restore Jest cache
        uses: actions/cache@v4
        with:
          path: .jest-cache
          key: jest-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            jest-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-

      - name: Download resume data
        run: npm run download-resume-json

      - name: Run tests and collect coverage
        run: npm run test:coverage -- --cacheDirectory=.jest-cache --coverageThreshold='{}'

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build
    needs: install
    uses: ./.github/workflows/reusable-build.yml
    secrets:
      NEXT_PUBLIC_EDIT_PASSWORD_HASH: ${{ secrets.NEXT_PUBLIC_EDIT_PASSWORD_HASH }}
      NEXT_PUBLIC_HF_TOKEN: ${{ secrets.NEXT_PUBLIC_HF_TOKEN }}
